# Python

## 常用脚本

### 如何测试 `isinstance()` 和 `type()` 的执行性能

```bash
# Python 3.11.8

$ python -m timeit -s "variable = 'hello'" "isinstance(variable, str)"
20000000 loops, best of 5: 16.2 nsec per loop

$ python -m timeit -s "variable = 'hello'" "isinstance(variable, str)"
20000000 loops, best of 5: 14.9 nsec per loop
```

### 如何用 [cProfile](https://docs.python.org/3/library/profile.html) 测量代码执行效率

<details>
  <summary>cProfile_examples.py</summary>

```python
import cProfile

from rich.console import Console

console = Console().print


# 常规版
def fib1(n):
    if n == 0:
        return 0
    elif n == 1:
        return 1
    else:
        return fib1(n - 1) + fib1(n - 2)


# 改进版
def memoize(f):
    memo = {}

    def helper(x):
        if x not in memo:
            memo[x] = f(x)
        return memo[x]

    return helper


@memoize
def fib2(n):
    if n < 2:
        return n
    return fib2(n - 1) + fib2(n - 2)


def fib_seq(n):
    res = []
    if n > 0:
        res.extend(fib_seq(n - 1))
    res.append(fib2(n))
    return res


console(fib_seq(30))
# 等效于 python -m cProfile cProfile_examples.py
cProfile.run("fib_seq(30)")
```

</details>

## 如何爬取 [bing 壁纸](https://mouday.github.io/wallpaper-database/2024/03/20.json)并写入文件

<details>
  <summary>crawl_bing_wallpaper.py</summary>

```py
"""
cd src/app/(unauth)/python
python crawl_bing_wallpaper.py
"""

import json
import os
import time
from datetime import datetime, timedelta
from threading import Thread

import requests
from rich.console import Console

console = Console().print

class MultiThreadRequest(Thread):
def **init**(self, func, args=()):
super(MultiThreadRequest, self).**init**()
self.func = func
self.args = args

    def run(self) -> None:
        self.result = self.func(*self.args)

    def get_result(self):
        try:
            return self.result
        except Exception as e:
            return e.args[0]

def get_days(begin_date: str = "2022-10-26"):
date_list = []
\_begin_date: datetime = datetime.strptime(begin_date, "%Y-%m-%d")
end_date: datetime = datetime.strptime(
time.strftime("%Y-%m-%d", time.localtime(time.time())), "%Y-%m-%d"
)
while \_begin_date <= end_date:
date_str = \_begin_date.strftime("%Y-%m-%d")
date_list.append(date_str)
\_begin_date += timedelta(days=1)
return date_list

def get_bing_data(day: str):
ymd = day.split("-") # https://mouday.github.io/wallpaper-database/2024/03/20.json
res = requests.get(
f"https://mouday.github.io/wallpaper-database/{ymd[0]}/{ymd[1]}/{ymd[2]}.json"
)
if res.ok:
return day, res.status_code, res.json()
else:
console(day, res.ok)
return day, res.status_code, {}

def run():
days = get_days() # ['2022-10-26', '2022-10-27', ...]
tasks = list()
results = []
for day in days:
t = MultiThreadRequest(get_bing_data, args=(day,))
tasks.append(t)
t.start()

    for t in tasks:
        t.join()
        result = t.get_result()
        if result[1] != 200:
            pass
        else:
            result[2]["date"] = result[2].get("date", result[0]).replace("-", "/")
            results.append(result[2])
    # console(results)
    BASE_PATH: str = os.getcwd()
    with open(BASE_PATH + "/bing_wallpaper.json", "w", encoding="utf-8") as f:
        json.dump(results, f, indent=2, ensure_ascii=False)

if **name** == "**main**":
run()

```

</details>
